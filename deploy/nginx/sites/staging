server {

	listen $vpdb_staging_serverport ssl;
	server_name $vpdb_staging_servername;

	# path to your certs
	ssl_certificate      $vpdb_staging_ssl_certificate;
	ssl_certificate_key  $vpdb_staging_ssl_certificate_key;

	# protect this
	auth_basic "Restricted";
	auth_basic_user_file /var/www/.htpasswd;

	# these are the static assets
	location ~ ^/(css/|fonts/|images/|js/global|json/|lib/|robots.txt|humans.txt) {
		root $vpdb_staging_path_cache;
		access_log off;
		expires max;
	}

	# favicons
	location ~ ^/(favicon|mstile|apple-touch-icon) {
		root $vpdb_staging_path_cache/images/favicon;
		access_log off;
		expires max;
	}

	# javascripts
	location ~ ^/js/ {
		root $vpdb_staging_path_current/client/code;
		rewrite ^/js/(.*)$ /$1 break;
		access_log off;
		expires max;
	}

	# static html files
	location ~ .*\.html$ {
		root $vpdb_staging_path_cache/html;
		access_log off;
		expires max;
	}

	# api (remove -mock and the rest when fake data is gone)
	location ~ ^/(api(-mock)?|storage|avatars|asset|packs)/ {
		proxy_redirect off;
		proxy_set_header X-Real-IP         $remote_addr;
		proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
		proxy_set_header Host              $http_host;
		proxy_set_header X-NginX-Proxy     true;
		proxy_set_header Connection "";
		proxy_http_version 1.1;
		#proxy_cache one;
		#proxy_cache_key vpdb$request_uri$scheme;
		proxy_pass http://vpdb_staging_upstream;

		error_page 403 /errors/403.html;
		error_page 404 /errors/404.html;
		error_page 500 /errors/500.html;
		error_page 502 /errors/502.html;
	}

	# style guide
	location ~ ^/styleguide {
		root $vpdb_staging_path_current;
		try_files $uri /styleguide/index.html;
		access_log off;
		expires max;
	}

	# if no hit, serve index
	location / {
		root $vpdb_staging_path_cache/html;
		try_files /index.html =404;
	}

}

# redirect to https
server {
	listen 80;
	server_name $vpdb_staging_servername;
	return 301 $vpdb_staging_serverurl:$vpdb_staging_serverport$request_uri;
}
